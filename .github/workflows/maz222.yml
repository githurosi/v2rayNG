name: 同步资产与更新日志（v2rayNG版）
on:
 push:
 branches: [ main ]
  # ... [保持原有触发器配置]
permissions:
 contents: write

jobs:
 sync:
 runs-on: ubuntu-latest
 env:
 VERSION: "1.2.3" # 新增环境变量定义
 steps:
 - name: 检出仓库
 uses: actions/checkout@v4
 with:
 fetch-depth: 1

 # 获取最新版本信息（增加重试和超时）
 - name: 获取最新版本信息
 id: latest-release
 run: |
 retry() { local max=$1; shift; for i in $(seq 1 $max); do "$@" && break || sleep $i; done }
 retry 3 curl -sSfL --connect-timeout 10 --max-time 30 https://api.github.com/repos/2dust/v2rayNG/releases/latest \
 | jq -r '.tag_name' > "$GITHUB_OUTPUT"

 # 下载最新版本资产（修复路径问题）
 - name: 下载最新版本资产
 run: |
 mkdir -p "最新版本/${{ steps.latest-release.outputs.TAG_NAME }}"
 for asset in $(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest \
 | jq -r '.assets[].name'); do
 wget -q --show-progress "$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest \
 | jq -r --arg name "$asset" '.assets[] | select(.name==$name) | .browser_download_url')" \
 -P "最新版本/${{ steps.latest-release.outputs.TAG_NAME }}"
 done

 # 智能同步逻辑（修复预发布检测）
 - name: 智能同步版本
 id: sync_logic
 run: |
 LATEST_TAG=$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest | jq -r '.tag_name')
 PRE_TAG=$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases?per_page=100 \
 | jq -r '[.[] | select(.prerelease == true)] | first?.tag_name')

 if [ "$PRE_TAG" != "null" ]; then
 echo "发现预发布版本: $PRE_TAG"
 # 预发布处理逻辑...
 else
 echo "当前无预发布版本"
 fi

 # 更新日志（修复文件处理错误）
 - name: 更新更新日志
 run: |
 # 使用临时文件避免冲突
 TEMP_FILE="$(mktemp)"
 trap 'rm -f "$TEMP_FILE"' EXIT
 
 # 获取翻译内容
 TRANSLATED_NOTES=$(curl -sSf "https://translate.google.cn/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest | jq -r '.body')") \
 | jq -r '.sentences[].trans'
 
 # 写入文件
 echo "$LATEST_TAG" > version.txt
 echo -e "## 📅 更新日志\n### $LATEST_TAG\n$TRANSLATED_NOTES" > "$TEMP_FILE"
 cp -f "$TEMP_FILE" README.md

 # 原子化提交（修复卡住问题）
 - name: 原子化提交更改
 uses: stefanzweifel/git-auto-commit-action@v5
 with:
 commit_message: |
 🔄 同步资产与更新日志
 最新版本: ${{ steps.latest-release.outputs.TAG_NAME }}
 支持环境: ${{ env.VERSION }}
 file_pattern: |
 最新版本/**
 预发布/**
 version.txt
 README.md
 timeout-minutes: 5 # 新增超时设置
