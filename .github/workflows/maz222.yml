name: åŒæ­¥èµ„äº§ä¸æ›´æ–°æ—¥å¿—ï¼ˆv2rayNGç‰ˆï¼‰
on:
 push:
 branches: [ main ]
  # ... [ä¿æŒåŸæœ‰è§¦å‘å™¨é…ç½®]
permissions:
 contents: write

jobs:
 sync:
 runs-on: ubuntu-latest
 env:
 VERSION: "1.2.3" # æ–°å¢ç¯å¢ƒå˜é‡å®šä¹‰
 steps:
 - name: æ£€å‡ºä»“åº“
 uses: actions/checkout@v4
 with:
 fetch-depth: 1

 # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¢åŠ é‡è¯•å’Œè¶…æ—¶ï¼‰
 - name: è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
 id: latest-release
 run: |
 retry() { local max=$1; shift; for i in $(seq 1 $max); do "$@" && break || sleep $i; done }
 retry 3 curl -sSfL --connect-timeout 10 --max-time 30 https://api.github.com/repos/2dust/v2rayNG/releases/latest \
 | jq -r '.tag_name' > "$GITHUB_OUTPUT"

 # ä¸‹è½½æœ€æ–°ç‰ˆæœ¬èµ„äº§ï¼ˆä¿®å¤è·¯å¾„é—®é¢˜ï¼‰
 - name: ä¸‹è½½æœ€æ–°ç‰ˆæœ¬èµ„äº§
 run: |
 mkdir -p "æœ€æ–°ç‰ˆæœ¬/${{ steps.latest-release.outputs.TAG_NAME }}"
 for asset in $(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest \
 | jq -r '.assets[].name'); do
 wget -q --show-progress "$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest \
 | jq -r --arg name "$asset" '.assets[] | select(.name==$name) | .browser_download_url')" \
 -P "æœ€æ–°ç‰ˆæœ¬/${{ steps.latest-release.outputs.TAG_NAME }}"
 done

 # æ™ºèƒ½åŒæ­¥é€»è¾‘ï¼ˆä¿®å¤é¢„å‘å¸ƒæ£€æµ‹ï¼‰
 - name: æ™ºèƒ½åŒæ­¥ç‰ˆæœ¬
 id: sync_logic
 run: |
 LATEST_TAG=$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest | jq -r '.tag_name')
 PRE_TAG=$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases?per_page=100 \
 | jq -r '[.[] | select(.prerelease == true)] | first?.tag_name')

 if [ "$PRE_TAG" != "null" ]; then
 echo "å‘ç°é¢„å‘å¸ƒç‰ˆæœ¬: $PRE_TAG"
 # é¢„å‘å¸ƒå¤„ç†é€»è¾‘...
 else
 echo "å½“å‰æ— é¢„å‘å¸ƒç‰ˆæœ¬"
 fi

 # æ›´æ–°æ—¥å¿—ï¼ˆä¿®å¤æ–‡ä»¶å¤„ç†é”™è¯¯ï¼‰
 - name: æ›´æ–°æ›´æ–°æ—¥å¿—
 run: |
 # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…å†²çª
 TEMP_FILE="$(mktemp)"
 trap 'rm -f "$TEMP_FILE"' EXIT
 
 # è·å–ç¿»è¯‘å†…å®¹
 TRANSLATED_NOTES=$(curl -sSf "https://translate.google.cn/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=$(curl -sSfL https://api.github.com/repos/2dust/v2rayNG/releases/latest | jq -r '.body')") \
 | jq -r '.sentences[].trans'
 
 # å†™å…¥æ–‡ä»¶
 echo "$LATEST_TAG" > version.txt
 echo -e "## ğŸ“… æ›´æ–°æ—¥å¿—\n### $LATEST_TAG\n$TRANSLATED_NOTES" > "$TEMP_FILE"
 cp -f "$TEMP_FILE" README.md

 # åŸå­åŒ–æäº¤ï¼ˆä¿®å¤å¡ä½é—®é¢˜ï¼‰
 - name: åŸå­åŒ–æäº¤æ›´æ”¹
 uses: stefanzweifel/git-auto-commit-action@v5
 with:
 commit_message: |
 ğŸ”„ åŒæ­¥èµ„äº§ä¸æ›´æ–°æ—¥å¿—
 æœ€æ–°ç‰ˆæœ¬: ${{ steps.latest-release.outputs.TAG_NAME }}
 æ”¯æŒç¯å¢ƒ: ${{ env.VERSION }}
 file_pattern: |
 æœ€æ–°ç‰ˆæœ¬/**
 é¢„å‘å¸ƒ/**
 version.txt
 README.md
 timeout-minutes: 5 # æ–°å¢è¶…æ—¶è®¾ç½®
