name: Auto Update MoneyPrinterTurbo

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"  # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿ç‰ˆæœ¬ç›¸åŒï¼‰'
        required: false
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_OWNER=harry0703" >> $GITHUB_ENV
          echo "REPO_NAME=MoneyPrinterTurbo" >> $GITHUB_ENV
          echo "TARGET_FILE=MoneyPrinterTurbo.zip" >> $GITHUB_ENV  # æ ¹æ®å®é™…æ–‡ä»¶åè°ƒæ•´

      - name: æ£€æŸ¥å¹¶æ›´æ–°Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ—¥å¿—å‡½æ•°
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          log "å¼€å§‹æ£€æŸ¥æ›´æ–°..."

          # è·å–æœ¬åœ°ç‰ˆæœ¬
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "0.0.0")
          log "æœ¬åœ°ç‰ˆæœ¬: ${LOCAL_VERSION}"

          # è·å–æœ€æ–°Release
          log "è·å–æœ€æ–°Releaseä¿¡æ¯..."
          API_URL="https://api.github.com/repos/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/releases/latest"
          RESPONSE=$(curl -s --retry 3 -H "Authorization: token $GITHUB_TOKEN" "$API_URL")
          
          if [ $? -ne 0 ]; then
            log "ERROR: æ— æ³•è®¿é—®GitHub API"
            exit 1
          fi

          TAG_NAME=$(echo "$RESPONSE" | jq -r '.tag_name')
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r ".assets[] | select(.name == \"${{ env.TARGET_FILE }}\") | .browser_download_url")

          if [ -z "$DOWNLOAD_URL" ]; then
            log "ERROR: æœªæ‰¾åˆ° ${{ env.TARGET_FILE }}"
            exit 1
          fi
          log "æœ€æ–°ç‰ˆæœ¬: $TAG_NAME"

          # ç‰ˆæœ¬æ¯”è¾ƒ
          if [ "$LOCAL_VERSION" = "$TAG_NAME" ] && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
            log "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            exit 0
          fi

          # ä¸‹è½½å¹¶æ›´æ–°
          log "ä¸‹è½½ ${{ env.TARGET_FILE }}..."
          wget -q --show-progress -O "${{ env.TARGET_FILE }}" "$DOWNLOAD_URL"
          
          # è§£å‹æ–‡ä»¶ï¼ˆæ ¹æ®å®é™…å‹ç¼©æ ¼å¼è°ƒæ•´ï¼‰
          case "${{ env.TARGET_FILE }}" in
            *.zip)
              unzip -o "${{ env.TARGET_FILE }}"
              ;;
            *.tar.gz)
              tar -xzvf "${{ env.TARGET_FILE }}"
              ;;
            *)
              log "æœªçŸ¥å‹ç¼©æ ¼å¼: ${{ env.TARGET_FILE }}"
              exit 1
          esac

          # æ¸…ç†æ—§æ–‡ä»¶
          find . -maxdepth 1 ! -name '*.md' ! -name 'LICENSE' ! -name '.git' ! -name 'version.txt' -exec rm -rf {} \;

          # ç§»åŠ¨è§£å‹å†…å®¹
          mv MoneyPrinterTurbo/* .  # æ ¹æ®å®é™…ç›®å½•ç»“æ„è°ƒæ•´
          rm -rf MoneyPrinterTurbo

          # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          echo "$TAG_NAME" > version.txt
          log "æ›´æ–°å®Œæˆï¼Œæ–°ç‰ˆæœ¬: $TAG_NAME"

      - name: æäº¤æ›´æ”¹
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥MoneyPrinterTurboç‰ˆæœ¬: ${{ env.TAG_NAME }}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: main

      - name: å¤±è´¥é€šçŸ¥
        if: ${{ failure() }}
        uses: imjohnbo/issue-bot@v3
        with:
          title: "æ›´æ–°å¤±è´¥è­¦æŠ¥ âš ï¸"
          body: |
            è‡ªåŠ¨æ›´æ–°MoneyPrinterTurboå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š
            1. ç½‘ç»œè¿æ¥
            2. ä»“åº“æƒé™
            3. Releaseèµ„äº§å®Œæ•´æ€§
            æœ€æ–°æ—¥å¿—ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          assignees: ${{ github.actor }}
          labels: "update-failed,bug"
