name: Auto Clone MoneyPrinterTurbo

on:
  push:
    branches:
      - main  # å½“ main åˆ†æ”¯è¢«æ¨é€æ—¶è‡ªåŠ¨è§¦å‘
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨3ç‚¹å®šæ—¶è§¦å‘ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æŒ‰é’®
    inputs:
      clean_clone:
        description: 'æ˜¯å¦æ‰§è¡Œå¹²å‡€å…‹éš†ï¼ˆåˆ é™¤æ—§æ–‡ä»¶ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write  # å…è®¸æäº¤æ›´æ”¹åˆ°ä»“åº“

jobs:
  clone_repo:
    runs-on: ubuntu-latest
    steps:
      # 1. åŸºç¡€æ£€å‡ºï¼ˆä½¿ç”¨å®˜æ–¹åŠ¨ä½œç¡®ä¿å¯é æ€§ï¼‰
      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: harry0703/MoneyPrinterTurbo  # ç›®æ ‡ä»“åº“åœ°å€
          path: ./moneyprinter-turbo  # è‡ªå®šä¹‰å·¥ä½œç›®å½•
          fetch-depth: 0  # å®Œæ•´å…‹éš†æ‰€æœ‰å†å²

      # 2. ç¯å¢ƒåˆå§‹åŒ–
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_NAME=MoneyPrinterTurbo" >> $GITHUB_ENV
          echo "CLONE_PATH=./moneyprinter-turbo" >> $GITHUB_ENV

      # 3. å¹²å‡€å…‹éš†é€»è¾‘ï¼ˆå¯é€‰ï¼‰
      - name: æ‰§è¡Œå¹²å‡€å…‹éš†
        if: github.event.inputs.clean_clone == 'true'
        run: |
          rm -rf ${{ env.CLONE_PATH }}/*
          rm -rf ${{ env.CLONE_PATH }}/.*

      # 4. éªŒè¯å…‹éš†ç»“æœ
      - name: æ ¡éªŒå…‹éš†å†…å®¹
        run: |
          # å…³é”®æ–‡ä»¶æ£€æŸ¥ï¼ˆæ ¹æ®å®é™…é¡¹ç›®è°ƒæ•´ï¼‰
          test -f ${{ env.CLONE_PATH }}/README.md || exit 1
          test -f ${{ env.CLONE_PATH }}/requirements.txt || exit 1
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find ${{ env.CLONE_PATH }} -type f | wc -l)
          echo "å…‹éš†æ–‡ä»¶æ€»æ•°: $FILE_COUNT"
          
          # éªŒè¯Gitå†å²
          git -C ${{ env.CLONE_PATH }} log --oneline | grep -q 'Initial commit'

      # 5. è‡ªåŠ¨æäº¤æ›´æ”¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: æäº¤å…‹éš†ç»“æœ
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½è®°å½•çŠ¶æ€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨å…‹éš† ${{ env.REPO_NAME }} [è·³è¿‡CI]"
          commit_options: '--no-verify'
          branch: main
          file_pattern: ${{ env.CLONE_PATH }}/*
          create_branch: false

      # 6. æ‰©å±•ï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆç¤ºä¾‹ï¼‰
      # - name: åŒæ­¥åˆ°ç”Ÿäº§æœåŠ¡å™¨
      #   uses: appleboy/scp-action@v0.1.4
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SERVER_KEY }}
      #     source: ${{ env.CLONE_PATH }}/*
      #     target: /var/www/moneyprinter
