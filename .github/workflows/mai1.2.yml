name: Auto Clone MoneyPrinterTurbo

on:
  push:
    branches:
      - main  # 当 main 分支被推送时自动触发
  schedule:
    - cron: '0 3 * * *'  # 每天凌晨3点定时触发（UTC时间）
  workflow_dispatch:  # 手动触发按钮
    inputs:
      clean_clone:
        description: '是否执行干净克隆（删除旧文件）'
        required: false
        default: 'false'

permissions:
  contents: write  # 允许提交更改到仓库

jobs:
  clone_repo:
    runs-on: ubuntu-latest
    steps:
      # 1. 基础检出（使用官方动作确保可靠性）
      - name: 检出目标仓库
        uses: actions/checkout@v4
        with:
          repository: harry0703/MoneyPrinterTurbo  # 目标仓库地址
          path: ./moneyprinter-turbo  # 自定义工作目录
          fetch-depth: 0  # 完整克隆所有历史

      # 2. 环境初始化
      - name: 设置环境变量
        run: |
          echo "REPO_NAME=MoneyPrinterTurbo" >> $GITHUB_ENV
          echo "CLONE_PATH=./moneyprinter-turbo" >> $GITHUB_ENV

      # 3. 干净克隆逻辑（可选）
      - name: 执行干净克隆
        if: github.event.inputs.clean_clone == 'true'
        run: |
          rm -rf ${{ env.CLONE_PATH }}/*
          rm -rf ${{ env.CLONE_PATH }}/.*

      # 4. 验证克隆结果
      - name: 校验克隆内容
        run: |
          # 关键文件检查（根据实际项目调整）
          test -f ${{ env.CLONE_PATH }}/README.md || exit 1
          test -f ${{ env.CLONE_PATH }}/requirements.txt || exit 1
          
          # 统计文件数量
          FILE_COUNT=$(find ${{ env.CLONE_PATH }} -type f | wc -l)
          echo "克隆文件总数: $FILE_COUNT"
          
          # 验证Git历史
          git -C ${{ env.CLONE_PATH }} log --oneline | grep -q 'Initial commit'

      # 5. 自动提交更改（如果需要）
      - name: 提交克隆结果
        if: always()  # 无论成功失败都记录状态
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 自动克隆 ${{ env.REPO_NAME }} [跳过CI]"
          commit_options: '--no-verify'
          branch: main
          file_pattern: ${{ env.CLONE_PATH }}/*
          create_branch: false

      # 6. 扩展：部署到服务器（示例）
      # - name: 同步到生产服务器
      #   uses: appleboy/scp-action@v0.1.4
      #   with:
      #     host: ${{ secrets.SERVER_HOST }}
      #     username: ${{ secrets.SERVER_USER }}
      #     key: ${{ secrets.SERVER_KEY }}
      #     source: ${{ env.CLONE_PATH }}/*
      #     target: /var/www/moneyprinter
